<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Inventory Management System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Include JsBarcode -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <!-- Include QuaggaJS -->
  <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
  <!-- Include FileSaver.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <!-- Include xlsx.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* CSS styles */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      overflow-x: hidden; /* Prevent horizontal scrolling */
    }

    #login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #fff;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border: 1px solid #ccc;
    }

    section {
      padding: 20px;
      margin: 20px;
      border: 1px solid #ccc;
    }

    h2, h3 {
      text-align: center;
    }

    #barcode {
      display: block;
      margin: 20px auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }

    table th, table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }

    table th {
      background-color: #f2f2f2;
    }

    button {
      padding: 10px 20px;
      margin: 5px;
    }

    input[type="date"], input[type="text"], select {
      padding: 5px;
      margin: 5px;
    }

    #interactive, #lookup-interactive {
      position: relative;
      width: 100%;
      max-width: 600px;
      margin: auto;
    }

    #interactive video, #lookup-interactive video {
      width: 100%;
    }

    #interactive canvas.drawingBuffer, #lookup-interactive canvas.drawingBuffer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
    }

    /* Hide QuaggaJS UI elements */
    #interactive .viewport, #lookup-interactive .viewport {
      display: none;
    }

    /* Styles for photo capture */
    #photo-capture {
      display: none;
      flex-direction: column;
      align-items: center;
    }

    #photo-capture video, #photo-capture img {
      width: 80%;
      max-width: 400px;
      margin: 10px 0;
    }

    #photo-gallery img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      margin: 5px;
    }

    /* Styles for item lookup */
    #item-lookup-section {
      display: none;
      flex-direction: column;
      align-items: center;
    }

    #item-photos img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      margin: 5px;
    }

    /* Admin Modal */
    #admin-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 9999;
      display: none;
      justify-content: center;
      align-items: center;
    }

    #admin-modal-content {
      background-color: #fff;
      padding: 20px;
      border-radius: 5px;
      text-align: center;
      border: 1px solid #ccc;
    }

    /* Top Right Button */
    #do-not-click {
      position: fixed;
      top: 10px;
      right: 10px;
    }

    /* Employee Selection */
    #employee-selection {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #employee-list {
      max-width: 300px;
      border: 1px solid #ccc;
      margin-bottom: 10px;
    }

    #employee-list tr {
      cursor: pointer;
    }

    #employee-list tr.selected {
      background-color: #d9edf7;
    }

    #employee-list tr:hover {
      background-color: #f5f5f5;
    }

    /* Post-Submission Prompt */
    #post-submission {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255,255,255,0.9);
      z-index: 9999;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    /* Admin Management Sections */
    #admin-section {
      display: none;
    }

    .admin-table {
      width: 80%;
      margin: auto;
    }

    .admin-table th, .admin-table td {
      padding: 10px;
      text-align: left;
    }

    .admin-button {
      margin: 5px;
    }
  </style>
</head>
<body onload="initializeApp();">

  <!-- Employee Login Screen -->
  <div id="login-screen">
    <h2>Please Select Your Name</h2>
    <div id="employee-selection">
      <table id="employee-list">
        <!-- Employee names will be populated here -->
      </table>
      <button onclick="employeeLogin()">Submit</button>
    </div>
  </div>

  <!-- Top Right Admin Button -->
  <button id="do-not-click" onclick="showAdminLogin()">Do not click</button>

  <!-- Admin Modal -->
  <div id="admin-modal">
    <div id="admin-modal-content">
      <h3>Admin Login</h3>
      <input type="text" id="admin-username" placeholder="Username"><br><br>
      <input type="password" id="admin-password" placeholder="Password"><br><br>
      <button onclick="adminLogin()">Login</button>
      <button onclick="closeAdminModal()">Cancel</button>
    </div>
  </div>

  <!-- Admin Controls -->
  <div id="admin-controls" style="display: none;">
    <button onclick="manageProjects()">Manage Projects</button>
    <button onclick="manageEmployees()">Manage Employees</button>
    <button onclick="logoutAdmin()">Logout Admin</button>
  </div>

  <!-- Admin Management Section -->
  <div id="admin-section">
    <!-- Content will be dynamically injected here -->
  </div>

  <!-- Barcode Generation Section -->
  <section id="barcode-generator">
    <h2>Generate Barcode</h2>
    <label for="item-name">Item Name:</label>
    <input type="text" id="item-name" required>
    <button onclick="startBarcodeGeneration()">Generate Barcode</button>

    <!-- Photo Capture Section -->
    <div id="photo-capture">
      <h3>Capture Photos</h3>
      <video id="camera-stream" autoplay playsinline></video>
      <button onclick="takePhoto()">Take Photo</button>
      <div id="photo-gallery"></div>
      <button onclick="saveItem()">Save</button>
    </div>

    <svg id="barcode"></svg>
    <button onclick="downloadBarcode()">Download Barcode</button>
  </section>

  <!-- Item Sign In/Out Section -->
  <section id="inventory-management">
    <h2>Inventory Management</h2>
    <button onclick="startScanner()">Start Scanner</button>
    <div id="interactive" class="viewport"></div>
    <form id="item-form" onsubmit="processItems(event)">
      <table id="item-table">
        <thead>
          <tr>
            <th>Barcode Number</th>
            <th>Item Name</th>
            <th>Quantity</th>
            <th>In/Out</th>
            <th>Project</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="item-tbody">
          <!-- Scanned items will appear here -->
        </tbody>
      </table>
      <label>
        <input type="checkbox" id="same-project-checkbox">
        Apply the same project to all items
      </label><br>
      <button type="button" onclick="addManualItem()">Add Additional Item</button>
      <button type="submit">Submit</button>
    </form>
  </section>

  <!-- Data Export Section -->
  <section id="data-export">
    <h2>Export Data</h2>
    <label for="start-date">Start Date:</label>
    <input type="date" id="start-date">
    <label for="end-date">End Date:</label>
    <input type="date" id="end-date">
    <button onclick="exportData()">Export to Excel</button>
  </section>

  <!-- Item Lookup Section -->
  <section id="item-lookup">
    <h2>Item Lookup</h2>
    <button onclick="startLookupScanner()">Lookup Item</button>
    <div id="lookup-interactive" class="viewport"></div>
    <div id="item-lookup-section">
      <h3>Item Details</h3>
      <p><strong>Item Name:</strong> <span id="lookup-item-name"></span></p>
      <p><strong>Barcode Number:</strong> <span id="lookup-barcode-number"></span></p>
      <p><strong>Current Stock Level:</strong> <span id="lookup-stock-level"></span></p>
      <h4>Photos:</h4>
      <div id="item-photos"></div>
      <h4>Last 5 Activities:</h4>
      <table id="activity-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Time</th>
            <th>Quantity</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="activity-tbody">
          <!-- Activity records will appear here -->
        </tbody>
      </table>
    </div>
  </section>

  <!-- Post-Submission Prompt -->
  <div id="post-submission">
    <h2>Would you like to sign out or continue?</h2>
    <button onclick="signOut()">Sign Out</button>
    <button onclick="continueSession()">Continue</button>
  </div>

  <!-- Include JavaScript -->
  <script>
    let db;
    let photos = []; // Array to store captured photos
    let currentBarcodeNumber = '';
    let currentItemName = '';
    let currentEmployee = '';
    let isAdmin = false;
    let employees = [];
    let projects = [];
    let applySameProject = false;
    let firstProjectSelected = '';

    // Initialize the app
    function initializeApp() {
      setupDatabase();
    }

    // Setup IndexedDB
    function setupDatabase() {
      const request = indexedDB.open("InventoryDB", 10); // Increment version number

      request.onupgradeneeded = function(event) {
        db = event.target.result;

        if (!db.objectStoreNames.contains("barcodes")) {
          const barcodeStore = db.createObjectStore("barcodes", { keyPath: "barcodeNumber" });
        }

        if (!db.objectStoreNames.contains("activities")) {
          const activityStore = db.createObjectStore("activities", { autoIncrement: true });
          activityStore.createIndex("barcodeNumber", "barcodeNumber", { unique: false });
        } else if (event.oldVersion < 4) {
          const activityStore = request.transaction.objectStore("activities");
          activityStore.createIndex("barcodeNumber", "barcodeNumber", { unique: false });
        }

        if (!db.objectStoreNames.contains("employees")) {
          const employeeStore = db.createObjectStore("employees", { keyPath: "id", autoIncrement: true });
          employeeStore.createIndex("name", "name", { unique: true });
        } else if (event.oldVersion < 10) {
          const employeeStore = request.transaction.objectStore("employees");
          if (!employeeStore.indexNames.contains("name")) {
            employeeStore.createIndex("name", "name", { unique: true });
          }
        }

        if (!db.objectStoreNames.contains("projects")) {
          const projectStore = db.createObjectStore("projects", { keyPath: "id", autoIncrement: true });
        }
      };

      request.onsuccess = function(event) {
        db = event.target.result;
        initializeData();
      };

      request.onerror = function(event) {
        console.error("Database error:", event.target.errorCode);
      };
    }

    // Initialize Default Data
    function initializeData() {
      const employeeTransaction = db.transaction(["employees"], "readwrite");
      const employeeStore = employeeTransaction.objectStore("employees");

      // Ensure the index on 'name' exists
      if (!employeeStore.indexNames.contains("name")) {
        employeeStore.createIndex("name", "name", { unique: true });
      }

      const index = employeeStore.index("name");
      const getJohnRequest = index.get("John");

      getJohnRequest.onsuccess = function(event) {
        const johnEmployee = event.target.result;
        if (!johnEmployee) {
          // 'John' does not exist, add him
          const addRequest = employeeStore.add({ name: "John" });
          addRequest.onsuccess = function(e) {
            // Now fetch all employees
            const getAllEmployeesRequest = employeeStore.getAll();
            getAllEmployeesRequest.onsuccess = function(event) {
              employees = event.target.result;
              populateEmployeeList();
            };
          };
        } else {
          // 'John' exists, fetch all employees
          const getAllEmployeesRequest = employeeStore.getAll();
          getAllEmployeesRequest.onsuccess = function(event) {
            employees = event.target.result;
            populateEmployeeList();
          };
        }
      };

      // Initialize projects array
      const projectTransaction = db.transaction(["projects"], "readonly");
      const projectStore = projectTransaction.objectStore("projects");
      const getAllProjects = projectStore.getAll();

      getAllProjects.onsuccess = function(event) {
        projects = event.target.result;
      };
    }

    // Populate Employee List
    function populateEmployeeList() {
      const employeeList = document.getElementById("employee-list");
      employeeList.innerHTML = '';
      // Sort employees alphabetically
      employees.sort((a, b) => a.name.localeCompare(b.name));

      employees.forEach(emp => {
        const row = document.createElement("tr");
        row.innerHTML = `<td>${emp.name}</td>`;
        row.dataset.name = emp.name;

        row.addEventListener('click', function() {
          // Remove 'selected' class from all rows
          const rows = document.querySelectorAll('#employee-list tr');
          rows.forEach(r => r.classList.remove('selected'));
          // Add 'selected' class to clicked row
          this.classList.add('selected');
          // Set currentEmployee
          currentEmployee = this.dataset.name;
        });

        employeeList.appendChild(row);
      });
    }

    // Employee Login
    function employeeLogin() {
      if (!currentEmployee) {
        alert("Please select your name from the list.");
        return;
      }
      document.getElementById("login-screen").style.display = "none";
    }

    // Show Admin Login Modal
    function showAdminLogin() {
      document.getElementById("admin-modal").style.display = "flex";
    }

    // Close Admin Modal
    function closeAdminModal() {
      document.getElementById("admin-modal").style.display = "none";
    }

    // Admin Login
    function adminLogin() {
      const username = document.getElementById("admin-username").value;
      const password = document.getElementById("admin-password").value;

      if (username === "John" && password === "Towne") {
        isAdmin = true;
        document.getElementById("admin-controls").style.display = "block";
        closeAdminModal();
        alert("Admin logged in.");
      } else {
        alert("Invalid credentials.");
      }
    }

    // Logout Admin
    function logoutAdmin() {
      isAdmin = false;
      document.getElementById("admin-controls").style.display = "none";
      document.getElementById("admin-section").style.display = "none";
      alert("Admin logged out.");
    }

    // Manage Projects
    function manageProjects() {
      if (!isAdmin) return;
      const adminSection = document.getElementById("admin-section");
      adminSection.innerHTML = '';
      adminSection.style.display = "block";

      const title = document.createElement("h2");
      title.textContent = "Manage Projects";
      adminSection.appendChild(title);

      const table = document.createElement("table");
      table.className = "admin-table";
      const thead = document.createElement("thead");
      thead.innerHTML = "<tr><th>Project Name</th><th>Actions</th></tr>";
      table.appendChild(thead);
      const tbody = document.createElement("tbody");

      projects.forEach(project => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td><input type="text" value="${project.name}" data-id="${project.id}"></td>
          <td>
            <button onclick="updateProject(${project.id}, this)">Update</button>
            <button onclick="deleteProject(${project.id})">Delete</button>
          </td>
        `;
        tbody.appendChild(row);
      });

      table.appendChild(tbody);
      adminSection.appendChild(table);

      const addButton = document.createElement("button");
      addButton.textContent = "Add New Project";
      addButton.onclick = addNewProject;
      adminSection.appendChild(addButton);
    }

    // Update Project
    function updateProject(id, button) {
      const row = button.parentNode.parentNode;
      const input = row.querySelector('input');
      const newName = input.value.trim();

      const projectTransaction = db.transaction(["projects"], "readwrite");
      const projectStore = projectTransaction.objectStore("projects");
      const getRequest = projectStore.get(id);

      getRequest.onsuccess = function(event) {
        const project = event.target.result;
        project.name = newName;
        projectStore.put(project);
        projects = projects.map(proj => proj.id === id ? project : proj);
        alert("Project updated.");
      };
    }

    // Delete Project
    function deleteProject(id) {
      if (confirm("Are you sure you want to delete this project?")) {
        const projectTransaction = db.transaction(["projects"], "readwrite");
        const projectStore = projectTransaction.objectStore("projects");
        projectStore.delete(id);
        projects = projects.filter(proj => proj.id !== id);
        manageProjects();
        alert("Project deleted.");
      }
    }

    // Add New Project
    function addNewProject() {
      const projectName = prompt("Enter new project name:");
      if (projectName) {
        const projectTransaction = db.transaction(["projects"], "readwrite");
        const projectStore = projectTransaction.objectStore("projects");
        const addRequest = projectStore.add({ name: projectName });

        addRequest.onsuccess = function(event) {
          const id = event.target.result;
          projects.push({ id, name: projectName });
          manageProjects();
          alert("Project added.");
        };
      }
    }

    // Manage Employees
    function manageEmployees() {
      if (!isAdmin) return;
      const adminSection = document.getElementById("admin-section");
      adminSection.innerHTML = '';
      adminSection.style.display = "block";

      const title = document.createElement("h2");
      title.textContent = "Manage Employees";
      adminSection.appendChild(title);

      const table = document.createElement("table");
      table.className = "admin-table";
      const thead = document.createElement("thead");
      thead.innerHTML = "<tr><th>Employee Name</th><th>Actions</th></tr>";
      table.appendChild(thead);
      const tbody = document.createElement("tbody");

      employees.forEach(employee => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td><input type="text" value="${employee.name}" data-id="${employee.id}"></td>
          <td>
            <button onclick="updateEmployee(${employee.id}, this)">Update</button>
            <button onclick="deleteEmployee(${employee.id})">Delete</button>
          </td>
        `;
        tbody.appendChild(row);
      });

      table.appendChild(tbody);
      adminSection.appendChild(table);

      const addButton = document.createElement("button");
      addButton.textContent = "Add New Employee";
      addButton.onclick = addNewEmployee;
      adminSection.appendChild(addButton);
    }

    // Update Employee
    function updateEmployee(id, button) {
      const row = button.parentNode.parentNode;
      const input = row.querySelector('input');
      const newName = input.value.trim();

      const employeeTransaction = db.transaction(["employees"], "readwrite");
      const employeeStore = employeeTransaction.objectStore("employees");
      const getRequest = employeeStore.get(id);

      getRequest.onsuccess = function(event) {
        const employee = event.target.result;
        employee.name = newName;
        employeeStore.put(employee);
        employees = employees.map(emp => emp.id === id ? employee : emp);
        populateEmployeeList();
        alert("Employee updated.");
      };
    }

    // Delete Employee
    function deleteEmployee(id) {
      if (confirm("Are you sure you want to delete this employee?")) {
        const employeeTransaction = db.transaction(["employees"], "readwrite");
        const employeeStore = employeeTransaction.objectStore("employees");
        employeeStore.delete(id);
        employees = employees.filter(emp => emp.id !== id);
        populateEmployeeList();
        manageEmployees();
        alert("Employee deleted.");
      }
    }

    // Add New Employee
    function addNewEmployee() {
      const employeeName = prompt("Enter new employee name:");
      if (employeeName) {
        const employeeTransaction = db.transaction(["employees"], "readwrite");
        const employeeStore = employeeTransaction.objectStore("employees");
        const addRequest = employeeStore.add({ name: employeeName });

        addRequest.onsuccess = function(event) {
          const id = event.target.result;
          employees.push({ id, name: employeeName });
          populateEmployeeList();
          manageEmployees();
          alert("Employee added.");
        };
      }
    }

    // Start Barcode Generation Process
    function startBarcodeGeneration() {
      const itemName = document.getElementById("item-name").value.trim();
      if (!itemName) {
        alert("Please enter an item name.");
        return;
      }
      currentItemName = itemName;
      currentBarcodeNumber = generateUniqueNumber().toString();
      generateBarcodeSVG(currentBarcodeNumber);
      startPhotoCapture();
    }

    // Generate a unique 6-digit number
    function generateUniqueNumber() {
      return Math.floor(100000 + Math.random() * 900000);
    }

    // Generate Barcode SVG
    function generateBarcodeSVG(barcodeNumber) {
      JsBarcode("#barcode", barcodeNumber, {
        format: "CODE128",
        displayValue: true,
        fontSize: 18
      });
    }

    // Start Photo Capture
    function startPhotoCapture() {
      const photoCapture = document.getElementById("photo-capture");
      const cameraStream = document.getElementById("camera-stream");
      photoCapture.style.display = "flex";
      photos = []; // Reset photos array
      document.getElementById("photo-gallery").innerHTML = "";

      // Check if page is served over HTTPS or localhost
      if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        alert("Camera access requires HTTPS. Please access this page over HTTPS or localhost.");
        return;
      }

      // Access the device camera
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          cameraStream.srcObject = stream;
        })
        .catch(err => {
          console.error("Error accessing camera:", err);
          if (err.name === 'NotAllowedError') {
            alert("Camera access has been denied. Please enable camera permissions in your browser settings and refresh the page.");
          } else if (err.name === 'NotFoundError') {
            alert("No camera device found. Please connect a camera and try again.");
          } else {
            alert(`Cannot access camera: ${err.name} - ${err.message}`);
          }
        });
    }

    // Take Photo
    function takePhoto() {
      const cameraStream = document.getElementById("camera-stream");
      const canvas = document.createElement("canvas");
      canvas.width = cameraStream.videoWidth;
      canvas.height = cameraStream.videoHeight;
      const context = canvas.getContext("2d");
      context.drawImage(cameraStream, 0, 0, canvas.width, canvas.height);
      const photoData = canvas.toDataURL("image/png");
      photos.push(photoData);

      // Display thumbnail
      const img = document.createElement("img");
      img.src = photoData;
      document.getElementById("photo-gallery").appendChild(img);
    }

    // Save Item after Photo Capture
    function saveItem() {
      // Stop the camera stream
      const cameraStream = document.getElementById("camera-stream");
      if (cameraStream.srcObject) {
        const tracks = cameraStream.srcObject.getTracks();
        tracks.forEach(track => track.stop());
        cameraStream.srcObject = null;
      }

      document.getElementById("photo-capture").style.display = "none";

      // Save barcode data to IndexedDB
      saveBarcode(currentBarcodeNumber, currentItemName, photos);
    }

    // Save barcode to IndexedDB
    function saveBarcode(barcodeNumber, itemName, photos) {
      const transaction = db.transaction(["barcodes"], "readwrite");
      const store = transaction.objectStore("barcodes");
      const data = {
        barcodeNumber,
        itemName,
        photos,
        generatedAt: new Date().toISOString()
      };
      const request = store.add(data);

      request.onsuccess = function() {
        console.log("Barcode saved:", barcodeNumber);
        alert("Item saved successfully.");
        document.getElementById("item-name").value = "";
      };

      request.onerror = function(event) {
        console.error("Error saving barcode:", event.target.error);
        alert("Error saving item. Please try again.");
      };
    }

    // Download Barcode Image
    function downloadBarcode() {
      const svg = document.getElementById("barcode");
      const serializer = new XMLSerializer();
      const svgBlob = new Blob([serializer.serializeToString(svg)], {type: "image/svg+xml;charset=utf-8"});
      const url = URL.createObjectURL(svgBlob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "barcode.svg";
      link.click();
      URL.revokeObjectURL(url);
    }

    // Start Scanner for Inventory Management
    function startScanner() {
      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.querySelector('#interactive'),
          constraints: {
            facingMode: "environment" // Use rear camera
          },
        },
        decoder: {
          readers: ["code_128_reader"] // Adjust according to barcode type
        }
      }, function(err) {
        if (err) {
          console.error(err);
          alert("Cannot access camera for scanning.");
          return;
        }
        console.log("Initialization finished. Ready to start");
        Quagga.start();
      });

      Quagga.onDetected(function(result) {
        const code = result.codeResult.code;
        Quagga.stop();
        addScannedItem(code);
      });
    }

    // Add Scanned Item
    function addScannedItem(barcodeNumber) {
      const transaction = db.transaction(["barcodes"], "readonly");
      const store = transaction.objectStore("barcodes");
      const request = store.get(barcodeNumber);

      request.onsuccess = function(event) {
        const record = event.target.result;
        const itemName = record ? record.itemName : "Unknown Item";

        const tbody = document.getElementById("item-tbody");
        const row = document.createElement("tr");

        row.innerHTML = `
          <td>${barcodeNumber}</td>
          <td>${itemName}</td>
          <td><input type="number" name="quantity" min="1" required></td>
          <td>
            <select name="action">
              <option value="In">In</option>
              <option value="Out">Out</option>
            </select>
          </td>
          <td>
            <select name="project">
              ${projects.map(proj => `<option value="${proj.name}">${proj.name}</option>`).join('')}
            </select>
          </td>
          <td><button type="button" onclick="removeItemRow(this)">Remove</button></td>
        `;

        tbody.appendChild(row);

        applySameProjectToNewRow(row);
      };

      request.onerror = function(event) {
        console.error("Error retrieving item:", event.target.error);
      };
    }

    // Add Manual Item
    function addManualItem() {
      const tbody = document.getElementById("item-tbody");
      const row = document.createElement("tr");

      row.innerHTML = `
        <td><input type="text" name="barcodeNumber" required></td>
        <td><input type="text" name="itemName" required></td>
        <td><input type="number" name="quantity" min="1" required></td>
        <td>
          <select name="action">
            <option value="In">In</option>
            <option value="Out">Out</option>
          </select>
        </td>
        <td>
          <select name="project">
            ${projects.map(proj => `<option value="${proj.name}">${proj.name}</option>`).join('')}
          </select>
        </td>
        <td><button type="button" onclick="removeItemRow(this)">Remove</button></td>
      `;

      tbody.appendChild(row);

      applySameProjectToNewRow(row);
    }

    // Apply Same Project to New Row
    function applySameProjectToNewRow(row) {
      const sameProjectCheckbox = document.getElementById("same-project-checkbox");
      const projectSelect = row.querySelector('select[name="project"]');

      if (applySameProject && firstProjectSelected) {
        projectSelect.value = firstProjectSelected;
      }

      sameProjectCheckbox.addEventListener('change', function() {
        applySameProject = this.checked;
        const firstRowProject = document.querySelector('#item-tbody tr:first-child select[name="project"]');
        if (firstRowProject) {
          firstProjectSelected = firstRowProject.value;
        }

        if (applySameProject) {
          const projectSelectsAll = document.querySelectorAll('#item-tbody select[name="project"]');
          projectSelectsAll.forEach(select => {
            select.value = firstProjectSelected;
          });
        }
      });

      // Update firstProjectSelected if the first project's value changes
      const firstRowProject = document.querySelector('#item-tbody tr:first-child select[name="project"]');
      if (firstRowProject) {
        firstRowProject.addEventListener('change', function() {
          if (applySameProject) {
            firstProjectSelected = this.value;
            const projectSelectsAll = document.querySelectorAll('#item-tbody select[name="project"]');
            projectSelectsAll.forEach(select => {
              select.value = firstProjectSelected;
            });
          }
        });
      }
    }

    // Remove Item Row
    function removeItemRow(button) {
      const row = button.parentNode.parentNode;
      row.parentNode.removeChild(row);
    }

    // Process Items
    function processItems(event) {
      event.preventDefault();
      const form = event.target;
      const items = [];
      const rows = form.querySelectorAll("tbody tr");

      rows.forEach(row => {
        const barcodeNumberInput = row.querySelector('input[name="barcodeNumber"]');
        const itemNameInput = row.querySelector('input[name="itemName"]');
        const barcodeNumber = barcodeNumberInput ? barcodeNumberInput.value : row.cells[0].innerText;
        const itemName = itemNameInput ? itemNameInput.value : row.cells[1].innerText;
        const quantity = parseInt(row.querySelector('input[name="quantity"]').value);
        const action = row.querySelector('select[name="action"]').value;
        const project = row.querySelector('select[name="project"]').value;
        const timestamp = new Date().toISOString();

        const item = {
          barcodeNumber,
          itemName,
          quantity,
          action,
          project,
          timestamp,
          employee: currentEmployee
        };

        items.push(item);

        // Save to IndexedDB
        const transaction = db.transaction(["activities"], "readwrite");
        const store = transaction.objectStore("activities");
        store.add(item);
      });

      // Clear the form
      document.getElementById("item-tbody").innerHTML = "";
      showPostSubmissionPrompt();
    }

    // Post-Submission Prompt
    function showPostSubmissionPrompt() {
      document.getElementById("post-submission").style.display = "flex";
    }

    function signOut() {
      document.getElementById("post-submission").style.display = "none";
      currentEmployee = '';
      document.getElementById("login-screen").style.display = "flex";
    }

    function continueSession() {
      document.getElementById("post-submission").style.display = "none";
    }

    // Export Data to Excel
    function exportData() {
      const startDate = document.getElementById("start-date").value;
      const endDate = document.getElementById("end-date").value;

      // Fetch activity data
      const activityTransaction = db.transaction(["activities"], "readonly");
      const activityStore = activityTransaction.objectStore("activities");
      const activityRequest = activityStore.getAll();

      activityRequest.onsuccess = function(event) {
        const allActivities = event.target.result;

        // Filter data based on date range
        const filteredActivities = allActivities.filter(record => {
          const recordDate = record.timestamp.substring(0, 10);
          return (!startDate || recordDate >= startDate) && (!endDate || recordDate <= endDate);
        });

        // Prepare activity data for Excel
        const activityData = filteredActivities.map(record => ({
          Date: record.timestamp.substring(0, 10),
          Time: record.timestamp.substring(11, 19),
          Employee: record.employee,
          "Barcode Number": record.barcodeNumber,
          "Item Name": record.itemName,
          Quantity: record.quantity,
          Action: record.action,
          Project: record.project
        }));

        // Fetch barcode data to calculate stock levels
        const barcodeTransaction = db.transaction(["barcodes"], "readonly");
        const barcodeStore = barcodeTransaction.objectStore("barcodes");
        const barcodeRequest = barcodeStore.getAll();

        barcodeRequest.onsuccess = function(event) {
          const allBarcodes = event.target.result;

          // Calculate current stock levels
          const stockLevels = {};

          allBarcodes.forEach(barcode => {
            stockLevels[barcode.barcodeNumber] = {
              barcodeNumber: barcode.barcodeNumber,
              itemName: barcode.itemName,
              currentStock: 0
            };
          });

          allActivities.forEach(activity => {
            if (stockLevels[activity.barcodeNumber]) {
              if (activity.action === "In") {
                stockLevels[activity.barcodeNumber].currentStock += activity.quantity;
              } else if (activity.action === "Out") {
                stockLevels[activity.barcodeNumber].currentStock -= activity.quantity;
              }
            }
          });

          // Prepare inventory data for Excel
          const inventoryData = Object.values(stockLevels).map(record => ({
            "Barcode Number": record.barcodeNumber,
            "Item Name": record.itemName,
            "Current Stock": record.currentStock
          }));

          // Generate worksheets
          const activityWorksheet = XLSX.utils.json_to_sheet(activityData);
          const inventoryWorksheet = XLSX.utils.json_to_sheet(inventoryData);

          // Create workbook and append sheets
          const workbook = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(workbook, activityWorksheet, "Activity History");
          XLSX.utils.book_append_sheet(workbook, inventoryWorksheet, "Inventory Stock Levels");

          // Write workbook and trigger download
          const wbout = XLSX.write(workbook, { bookType: "xlsx", type: "array" });
          saveAs(new Blob([wbout], { type: "application/octet-stream" }), "InventoryData.xlsx");
        };
      };
    }

    // Start Scanner for Item Lookup
    function startLookupScanner() {
      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.querySelector('#lookup-interactive'),
          constraints: {
            facingMode: "environment" // Use rear camera
          },
        },
        decoder: {
          readers: ["code_128_reader"] // Adjust according to barcode type
        }
      }, function(err) {
        if (err) {
          console.error(err);
          alert("Cannot access camera for scanning.");
          return;
        }
        console.log("Lookup scanner initialized.");
        Quagga.start();
      });

      Quagga.onDetected(function(result) {
        const code = result.codeResult.code;
        Quagga.stop();
        displayItemDetails(code);
      });
    }

    // Display Item Details
    function displayItemDetails(barcodeNumber) {
      const itemLookupSection = document.getElementById("item-lookup-section");
      const itemNameElement = document.getElementById("lookup-item-name");
      const barcodeNumberElement = document.getElementById("lookup-barcode-number");
      const stockLevelElement = document.getElementById("lookup-stock-level");
      const itemPhotosDiv = document.getElementById("item-photos");
      const activityTbody = document.getElementById("activity-tbody");

      // Clear previous data
      itemNameElement.textContent = "";
      barcodeNumberElement.textContent = "";
      stockLevelElement.textContent = "";
      itemPhotosDiv.innerHTML = "";
      activityTbody.innerHTML = "";

      // Fetch item data
      const barcodeTransaction = db.transaction(["barcodes"], "readonly");
      const barcodeStore = barcodeTransaction.objectStore("barcodes");
      const barcodeRequest = barcodeStore.get(barcodeNumber);

      barcodeRequest.onsuccess = function(event) {
        const itemRecord = event.target.result;

        if (itemRecord) {
          itemNameElement.textContent = itemRecord.itemName;
          barcodeNumberElement.textContent = itemRecord.barcodeNumber;

          // Display photos
          if (itemRecord.photos && itemRecord.photos.length > 0) {
            itemRecord.photos.forEach(photoData => {
              const img = document.createElement("img");
              img.src = photoData;
              itemPhotosDiv.appendChild(img);
            });
          } else {
            itemPhotosDiv.textContent = "No photos available.";
          }

          // Calculate current stock level
          const activityTransaction = db.transaction(["activities"], "readonly");
          const activityStore = activityTransaction.objectStore("activities");
          const index = activityStore.index("barcodeNumber");
          const range = IDBKeyRange.only(barcodeNumber);
          const activityRequest = index.getAll(range);

          activityRequest.onsuccess = function(event) {
            const activities = event.target.result;
            let currentStock = 0;

            activities.forEach(activity => {
              if (activity.action === "In") {
                currentStock += activity.quantity;
              } else if (activity.action === "Out") {
                currentStock -= activity.quantity;
              }
            });

            stockLevelElement.textContent = currentStock;

            // Display last 5 activities
            const lastFiveActivities = activities.slice(-5).reverse(); // Get last 5 records
            lastFiveActivities.forEach(activity => {
              const row = document.createElement("tr");
              row.innerHTML = `
                <td>${activity.timestamp.substring(0, 10)}</td>
                <td>${activity.timestamp.substring(11, 19)}</td>
                <td>${activity.quantity}</td>
                <td>${activity.action}</td>
              `;
              activityTbody.appendChild(row);
            });
          };
        } else {
          alert("Item not found in inventory.");
        }
      };

      barcodeRequest.onerror = function(event) {
        console.error("Error retrieving item:", event.target.error);
      };

      itemLookupSection.style.display = "flex";
    }

    // Close QuaggaJS when not in use
    window.addEventListener('unload', function() {
      if (Quagga) {
        Quagga.stop();
      }
    });
  </script>
</body>
</html>
